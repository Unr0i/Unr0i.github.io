---
layout:     post
title:      Windows hook技术研究1
subtitle:   微信外发消息审计管控方案研究
date:       2023-08-21
author:     LanKai
header-img: img/post-bg-debug.png
catalog: true
tags:
    - Windows
    - Hook
    - 逆向
---


## 主题
- 某些场所保密性要求高，即时通讯软件提供便利的同时，数据外发就成了泄密的一个源头，如何高效稳定地监管外发消息值得研究一下
- 外发审计所使用到的基本都是hook技术，但是hook的选择也决定了稳定性和用户的影响程度，可能卡顿、崩溃，无法获取全部的数据，没触发发送按键也进行了审计
- 本文主要研究微信外发消息的审计和管控

### 正文

#### 1、信息汇总
- PC端微信外发需要审计的消息类型：
  - 1、文本
  - 2、图片、截图
  - 3、文件
  - 4、留言(依赖于发送文件操作)
  - 5、小图标icon
- 外发文件的方式
  - 1、点击微信聊天界面图标点选文件
  - 2、鼠标拖拽文件到聊天界面
- 发送方式
  - 1、点击界面的发送按键
  - 2、Enter或shift+Enter

#### 2、深入
- 借助CE扫描内存，多次后确定出发送消息使用的接收方的微信ID的内存地址，关键模块是WeChatWin.dll
- x64dbg附加微信进程，可以看到多个同名进程，根据启动参数选择所需要的目标进程
- 内存中定位到获取的微信ID的内存地址，下断点，外发一条消息
- 通过断点，不断向上分析函数调用栈。。。。

#### 3、功成
- 找到了一个外发以后处理多条信息的函数，只有在触发发送按键以后才会得到执行，其余动作不影响，用户无感知，体验基本无影响
- 通过hook该函数可以获取除留言以外的所有文件类型，留言属于文本类型，但是没有消息号，所以不会进入上面的那个函数处理，在另外一个函数中获取地址
- 截图的外发是落地一个临时文件，外发时上传的是图片的本地路径
- 通过隐性特征数据可以实现兼容，升级版本也适用
- 阻断外发时，把消息号改成1~6以外的数字即可
- 留言信息通过清空字符串地址和长度即可

#### 4、后续
- 产出一篇相关发明专利


